# HLM
Heterogeneous Loop Model (HLM) is a computational approach with which to generate three-dimensional (3D) chromosome structures from Hi-C data. It is effectively a multiblock copolymer model in which monomer-monomer interactions (loops) are harmonically restrained with varying interaction strength (*k_ij*). Details about this method can be found in our [paper](https://www.cell.com/biophysj/fulltext/S0006-3495(19)30540-5) (DOI: 10.1016/j.bpj.2019.06.032). The whole modeling includes two steps.
1. Build an interaction strength matrix *{k_ij}* based on a contact frequency matrix *{p_ij}*.
2. Run Molecular Dynamics (MD) simulations with the parameters *{k_ij}* to generate an ensemble of 3D structures. 
>***Updates:*** 
>We have applied HLM to different epigenetic domains in *Drosophila*, which highlights their distinct structural features. See more details at [HLM-Epidom](https://github.com/leiliu2015/HLM-Epidom).

### System Requirements
The code was tested on ubuntu 14.04/16.04 LTS. We recommand [Anaconda](https://www.anaconda.com/distribution/) to manage the Python environment (Python 2.7) and other required packages (NumPy, SciPy, Numba, and scikit-learn). We used [Gnuplot](gnuplot.sourceforge.net) to visualize the results, and [ESPResSo 3.3.1 package](http://espressomd.org/wordpress/) to perform MD simulations (*optional*). Please refer to their websites for the instructions of installation.

### File Description
- toyModel/
  - [L2-gnm.kij.reference](toyModel/L2-gnm.kij.reference) (The *true* values of *{k_ij}*)
  - [L2-gnm.t0-0.rc1.0.cm](toyModel/L2-gnm.t0-0.rc1.0.cm) (*{p_ij}* based on MD simulations, which is used as the input of HLM)
  - [hlm.py](toyModel/hlm.py) (A Python script to infer *{k_ij}* from *{p_ij}*)
  - [hlm.gnu](toyModel/hlm.gnu) (A Gnuplot script to plot the results)
- GM12878-chr5-90-100Mb-50kb/
  - [chr5_50kb.090-100Mb.Hi-C.cm](GM12878-chr5-90-100Mb-50kb/chr5_50kb.090-100Mb.Hi-C.cm) (*{p_ij}* measured by [Rao *et al.*](https://www.cell.com/cell/fulltext/S0092-8674(14)01497-4?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS0092867414014974%3Fshowall%3Dtrue) with Hi-C, which is used as the input of HLM)
  - [hlm.py](GM12878-chr5-90-100Mb-50kb/hlm.py) (A Python script to infer *{k_ij}* from *{p_ij}*)
  - [hlm.gnu](GM12878-chr5-90-100Mb-50kb/hlm.gnu) (A Gnuplot script to plot the results)
  - MD/
    - [hlm_espresso.tcl](GM12878-chr5-90-100Mb-50kb/MD/hlm_espresso.tcl) (A TCL script used as the input of ESPResSo)
    - [chr5_50kb.090-100Mb.iniCfg](GM12878-chr5-90-100Mb-50kb/MD/chr5_50kb.090-100Mb.iniCfg) (A initial input configuration read by the TCL script)
    - [chr5_50kb.090-100Mb.HLM-MD.cm](GM12878-chr5-90-100Mb-50kb/MD/chr5_50kb.090-100Mb.HLM-MD.cm) (*{p_ij}* based on 3D structures generated by MD simulations)
- [clearAll.sh](clearAll.sh) (A Bash script to remove all the outputs)

### User Guide
We provide two examples to illustrate how HLM works. The first one in the [toyModel](toyModel/) folder uses a chain with two nested loops to demonstrate how to infer *{k_ij}* from *{p_ij}* (see Fig. S4 in the [paper](https://www.cell.com/biophysj/fulltext/S0006-3495(19)30540-5) for details). To run this demo, type the following lines at the root of the repository in your terminal.
```
$ cd ./toyModel
$ python hlm.py L2-gnm.t0-0.rc1.0.cm
$ gnuplot -persist hlm.gnu
```
The second example in the [GM12878-chr5-90-100Mb-50kb](GM12878-chr5-90-100Mb-50kb/) folder shows the pipeline to build 3D structures of a 10-Mb region on chromosome 5 at a resolution of 50 kb (see Fig. 1 in our [paper](https://www.cell.com/biophysj/fulltext/S0006-3495(19)30540-5)). The first step of this demo is very similar to the previous one.
```
$ cd ./GM12878-chr5-90-100Mb-50kb
$ python hlm.py chr5_50kb.090-100Mb.Hi-C.cm
$ gnuplot -persist hlm.gnu
```
The values of *{k_ij}* will be stored in a output file called `chr5_50kb.090-100Mb.oeL400W2.km`. As the second step (*optional*), we run MD simulation with those parameters using ESPResSo.
```
$ cd ./MD
$ cp ../chr5_50kb.090-100Mb.oeL400W2.km ./
$ Espresso hlm_espresso.tcl
```
It takes a few hours to finish the simulation with a single CPU, which generates $10^{4}$ structures of the chromatin chain. Next, one can compute the contact frequency matrix *{p_ij}* based on these structures. To save your time, we have provided the [results](GM12878-chr5-90-100Mb-50kb/MD/chr5_50kb.090-100Mb.HLM-MD.cm) in the MD folder. All the output files will be deleted by typing `$ bash ./clearAll.sh` at the root of the repository. If you are interested in HLM, or have further questions about it, please send an email to Lei Liu (leiliu2015@163.com).


